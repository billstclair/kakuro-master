<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>Kakuro Dojo</title>
  <script type="text/javascript" src="kakuro.js"></script>
  <script type="text/javascript" src="js/sha256.js"></script>
</head>

<body>
</body>

<script type="text/javascript">

// This must match modelVersion in SharedTypes.elm,
// or we ignore the saved state.
// Once it's in production, this file will need to have code to
// update old state to match current state.
var modelVersion = 6;

var storageName = 'kakuro-dojo';
var storedState = localStorage.getItem(storageName);
var startingState = storedState ? JSON.parse(storedState) : null;

if (startingState) {
  var version = startingState.version;
  if (version != modelVersion) {
    startingState = null;
  }
}

var kakuro = Elm.Kakuro.fullscreen(startingState);
kakuro.ports.setStorage.subscribe(function(state) {
    localStorage.setItem(storageName, JSON.stringify(state));
});

kakuro.ports.setTitle.subscribe(function(title) {
  document.title = title;
})

function specHash(spec) {
  var hash = sha256(spec);
  return hash.substring(0, 8);
}

function log (x) {
  console.log(x+"\n");
}

kakuro.ports.saveGame.subscribe(function(specAndState) {
  var spec = specAndState[0]
  var gameState = specAndState[1]
  var hash = specHash(spec);
  var json = JSON.stringify(gameState)
  //log("Saving: " + hash + ", from: " + spec + " as: " + json);
  localStorage.setItem(hash, json);
});

// This isn't restoring yet. It just sends the hash back
kakuro.ports.requestGame.subscribe(function(spec) {
  var hash = specHash(spec);
  var json = localStorage.getItem(hash);
  //log("Restored: " + hash + " from: " + spec + " as: " + json);
  var gameState = json ? JSON.parse(json) : null;
  if (gameState != null && gameState.version != modelVersion) {
    gameState = null;
  }
  kakuro.ports.receiveGame.send(gameState);
});

</script>

</html>
